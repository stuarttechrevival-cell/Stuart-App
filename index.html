<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stuart/Wessel — Stock Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Familjen+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#080c0f;--bg2:#0e1419;--bg3:#151d24;--bg4:#1c262f;
  --border:#1e2d38;--border2:#2a3d4a;
  --accent:#00d4ff;--accent2:#ff4757;--accent3:#2ed573;--accent4:#ffa502;
  --text:#e8f4f8;--text2:#8faab8;--text3:#4a6a7a;
  --mono:'DM Mono',monospace;--sans:'Familjen Grotesk',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:14px;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
header{position:sticky;top:0;z-index:100;background:rgba(8,12,15,0.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:56px;}
.logo{font-family:var(--mono);font-size:13px;font-weight:500;letter-spacing:3px;text-transform:uppercase;color:var(--accent);}
.logo span{color:var(--text3);}
.header-right{display:flex;align-items:center;gap:16px;font-family:var(--mono);font-size:11px;}
.sync-indicator{display:flex;align-items:center;gap:6px;color:var(--text3);}
.dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);animation:blink 2s infinite;}
.dot.red{background:var(--accent2);animation:none;}
.dot.yellow{background:var(--accent4);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
.app{display:flex;min-height:calc(100vh - 56px);position:relative;z-index:1;}
aside{width:210px;min-width:210px;border-right:1px solid var(--border);padding:16px 0;background:var(--bg);position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto;}
.nav-label{font-family:var(--mono);font-size:9px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;padding:0 16px;margin-bottom:4px;margin-top:12px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:500;transition:all 0.15s;border-left:2px solid transparent;}
.nav-item:hover{color:var(--text);background:var(--bg2);}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(0,212,255,0.05);}
.nav-badge{margin-left:auto;background:var(--accent2);color:#fff;font-size:9px;font-family:var(--mono);padding:2px 5px;border-radius:2px;}
.sync-btn{margin:12px 16px 0;width:calc(100% - 32px);background:var(--accent);color:#000;border:none;padding:9px;font-family:var(--mono);font-size:11px;font-weight:500;letter-spacing:1px;text-transform:uppercase;cursor:pointer;border-radius:2px;transition:opacity 0.15s;}
.sync-btn:hover{opacity:0.85;}
.sync-btn:disabled{opacity:0.4;cursor:not-allowed;}
.sync-status{margin:8px 16px;font-family:var(--mono);font-size:10px;color:var(--text3);}
main{flex:1;overflow-y:auto;}
.page{display:none;padding:28px;}
.page.active{display:block;animation:fadeUp 0.2s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.page-title{font-family:var(--mono);font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--accent);margin-bottom:6px;}
.page-heading{font-family:var(--sans);font-size:28px;font-weight:700;line-height:1;letter-spacing:-0.5px;}
.page-sub{color:var(--text2);font-size:13px;margin-top:6px;margin-bottom:24px;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border:1px solid var(--border);margin-bottom:24px;}
.stat{background:var(--bg2);padding:18px;position:relative;overflow:hidden;}
.stat::after{content:'';position:absolute;top:0;left:0;width:2px;height:100%;}
.stat.blue::after{background:var(--accent)}.stat.green::after{background:var(--accent3)}.stat.red::after{background:var(--accent2)}.stat.yellow::after{background:var(--accent4)}
.stat-label{font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--text3);text-transform:uppercase;margin-bottom:8px;}
.stat-val{font-family:var(--mono);font-size:28px;font-weight:500;line-height:1;}
.stat-val.blue{color:var(--accent)}.stat-val.green{color:var(--accent3)}.stat-val.red{color:var(--accent2)}.stat-val.yellow{color:var(--accent4)}
.stat-sub{font-size:11px;color:var(--text3);margin-top:5px;font-family:var(--mono);}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:18px;}
.card-title{font-family:var(--mono);font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:14px;}
.table-wrap{border:1px solid var(--border);overflow:auto;border-radius:2px;max-height:600px;}
table{width:100%;border-collapse:collapse;}
thead tr{background:var(--bg3);border-bottom:1px solid var(--accent);position:sticky;top:0;}
th{padding:10px 12px;text-align:left;font-family:var(--mono);font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);white-space:nowrap;}
td{padding:9px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:var(--bg3);}
.badge{display:inline-block;padding:2px 7px;border-radius:2px;font-family:var(--mono);font-size:10px;font-weight:500;letter-spacing:1px;text-transform:uppercase;}
.badge-blue{background:rgba(0,212,255,0.12);color:var(--accent);border:1px solid rgba(0,212,255,0.25)}
.badge-green{background:rgba(46,213,115,0.12);color:var(--accent3);border:1px solid rgba(46,213,115,0.25)}
.badge-red{background:rgba(255,71,87,0.12);color:var(--accent2);border:1px solid rgba(255,71,87,0.25)}
.badge-yellow{background:rgba(255,165,2,0.12);color:var(--accent4);border:1px solid rgba(255,165,2,0.25)}
.toolbar{display:flex;gap:10px;margin-bottom:14px;align-items:center;flex-wrap:wrap;}
.search-input{flex:1;min-width:180px;background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:7px 11px;font-family:var(--mono);font-size:12px;border-radius:2px;}
.search-input:focus{outline:none;border-color:var(--accent);}
.filter-select{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:7px 11px;font-family:var(--mono);font-size:12px;border-radius:2px;cursor:pointer;}
.filter-select:focus{outline:none;border-color:var(--accent);}
.progress{height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:5px;}
.progress-fill{height:100%;border-radius:2px;transition:width 0.6s ease;}
.alert{padding:11px 14px;border-radius:2px;font-size:13px;margin-bottom:10px;border-left:3px solid;}
.alert-red{border-color:var(--accent2);background:rgba(255,71,87,0.08)}
.alert-yellow{border-color:var(--accent4);background:rgba(255,165,2,0.08)}
.alert-green{border-color:var(--accent3);background:rgba(46,213,115,0.08)}
.alert-blue{border-color:var(--accent);background:rgba(0,212,255,0.08)}
.empty{text-align:center;padding:50px;color:var(--text3);}
.empty-title{font-family:var(--mono);font-size:13px;letter-spacing:2px;margin-bottom:6px;text-transform:uppercase;}
.sku{font-family:var(--mono);font-size:11px;color:var(--text3);}
.num{font-family:var(--mono);}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.section-gap{margin-bottom:20px;}
.urgency-bar{height:4px;border-radius:2px;margin-top:4px;}
.tab-row{display:flex;gap:0;margin-bottom:20px;border-bottom:1px solid var(--border);}
.tab{padding:8px 16px;font-family:var(--mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-content{display:none;}
.tab-content.active{display:block;}
</style>
</head>
<body>
<header>
  <div class="logo">Stuart<span>/</span>Wessel <span style="color:var(--text3);letter-spacing:1px;font-size:10px">STOCK INTELLIGENCE</span></div>
  <div class="header-right">
    <div class="sync-indicator"><div class="dot" id="sync-dot"></div><span id="sync-label">NOT CONNECTED</span></div>
    <span style="color:var(--text3)">|</span>
    <span id="last-sync" style="color:var(--text3)">—</span>
    <span style="color:var(--text3)">ZA · 20 REPAIRS/DAY</span>
  </div>
</header>

<div class="app">
  <aside>
    <button class="sync-btn" onclick="loadAll()" id="load-btn">⟳ SYNC DATA</button>
    <div class="sync-status" id="sync-status">Click sync to load</div>

    <div class="nav-label">Daily Operations</div>
    <div class="nav-item active" data-page="dashboard" onclick="nav(this)">◈ Dashboard</div>
    <div class="nav-item" data-page="reorder" onclick="nav(this)">⚡ Reorder Now <span class="nav-badge" id="reorder-badge" style="display:none">0</span></div>
    <div class="nav-item" data-page="runout" onclick="nav(this)">⏱ 7-Day Runout <span class="nav-badge" id="runout-badge" style="display:none">0</span></div>

    <div class="nav-label">Analysis</div>
    <div class="nav-item" data-page="topmovers" onclick="nav(this)">▲ Top Movers</div>
    <div class="nav-item" data-page="catalogue" onclick="nav(this)">⊞ Catalogue</div>
    <div class="nav-item" data-page="deadstock" onclick="nav(this)">◎ Dead Stock</div>
    <div class="nav-item" data-page="forecast" onclick="nav(this)">◆ Forecast</div>
  </aside>

  <main>

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-title">Overview</div>
      <div class="page-heading">Stock Dashboard</div>
      <div class="page-sub" id="dashboard-sub">Sync data to begin</div>

      <div class="stats-row" id="stats-row">
        <div class="stat blue"><div class="stat-label">Active SKUs</div><div class="stat-val blue" id="s-skus">—</div><div class="stat-sub">In use this month</div></div>
        <div class="stat green"><div class="stat-label">Total In Stock</div><div class="stat-val green" id="s-stock">—</div><div class="stat-sub">Units available</div></div>
        <div class="stat yellow"><div class="stat-label">Sold This Month</div><div class="stat-val yellow" id="s-sold">—</div><div class="stat-sub">Parts used in sales</div></div>
        <div class="stat red"><div class="stat-label">Need Reorder</div><div class="stat-val red" id="s-reorder">—</div><div class="stat-sub">Below safe level</div></div>
      </div>

      <div class="three-col section-gap">
        <div class="card"><div class="stat-label" style="margin-bottom:8px">Daily Usage Rate</div><div class="stat-val blue" id="d-daily">—</div><div class="stat-sub">Parts/day (30d avg)</div></div>
        <div class="card"><div class="stat-label" style="margin-bottom:8px">Weekly Usage Rate</div><div class="stat-val yellow" id="d-weekly">—</div><div class="stat-sub">Parts/week (30d avg)</div></div>
        <div class="card"><div class="stat-label" style="margin-bottom:8px">Avg Days Cover</div><div class="stat-val green" id="d-cover">—</div><div class="stat-sub">At current usage rate</div></div>
      </div>

      <div class="two-col section-gap">
        <div class="card"><div class="card-title">Top 8 by Stock</div><div id="top-stock-list"><div class="empty"><div class="empty-title">No data</div></div></div></div>
        <div class="card"><div class="card-title">Top 8 Sold This Month</div><div id="top-sold-list"><div class="empty"><div class="empty-title">No data</div></div></div></div>
      </div>

      <div class="two-col">
        <div class="card"><div class="card-title">Sales by Brand</div><div id="brand-breakdown"></div></div>
        <div class="card"><div class="card-title">Sales by Part Type</div><div id="type-breakdown"></div></div>
      </div>
    </div>

    <!-- REORDER NOW -->
    <div class="page" id="page-reorder">
      <div class="page-title">Action Required</div>
      <div class="page-heading">Reorder This Week</div>
      <div class="page-sub">Parts below safe stock level based on your 20 repairs/day rate and 2-3 day SA lead time</div>
      <div class="toolbar">
        <select class="filter-select" id="reorder-brand" onchange="renderReorder()"><option value="">All Brands</option></select>
        <select class="filter-select" id="reorder-type" onchange="renderReorder()"><option value="">All Types</option></select>
      </div>
      <div id="reorder-content"><div class="empty"><div class="empty-title">Sync data to view</div></div></div>
    </div>

    <!-- 7-DAY RUNOUT -->
    <div class="page" id="page-runout">
      <div class="page-title">Urgent</div>
      <div class="page-heading">Running Out in 7 Days</div>
      <div class="page-sub">Parts that will hit zero stock within 7 days at current usage rate</div>
      <div id="runout-content"><div class="empty"><div class="empty-title">Sync data to view</div></div></div>
    </div>

    <!-- TOP MOVERS -->
    <div class="page" id="page-topmovers">
      <div class="page-title">Usage Analysis</div>
      <div class="page-heading">Top 20 Fastest Movers</div>
      <div class="page-sub">Ranked by sales volume with daily, weekly and monthly rates</div>
      <div class="tab-row">
        <div class="tab active" onclick="switchTab(this,'tab-top-sold')">By Sales</div>
        <div class="tab" onclick="switchTab(this,'tab-top-daily')">By Daily Rate</div>
        <div class="tab" onclick="switchTab(this,'tab-top-cover')">Least Cover</div>
      </div>
      <div class="tab-content active" id="tab-top-sold"><div id="top-sold-table"></div></div>
      <div class="tab-content" id="tab-top-daily"><div id="top-daily-table"></div></div>
      <div class="tab-content" id="tab-top-cover"><div id="top-cover-table"></div></div>
    </div>

    <!-- CATALOGUE -->
    <div class="page" id="page-catalogue">
      <div class="page-title">Full Inventory</div>
      <div class="page-heading">Parts Catalogue</div>
      <div class="page-sub">All active SKUs with live stock and usage rates</div>
      <div class="toolbar">
        <input class="search-input" type="text" id="cat-search" placeholder="Search part, model, brand, SKU..." oninput="renderCatalogue()">
        <select class="filter-select" id="cat-brand" onchange="renderCatalogue()"><option value="">All Brands</option></select>
        <select class="filter-select" id="cat-type" onchange="renderCatalogue()"><option value="">All Types</option></select>
        <select class="filter-select" id="cat-sort" onchange="renderCatalogue()">
          <option value="stock-desc">Stock: High→Low</option>
          <option value="stock-asc">Stock: Low→High</option>
          <option value="sold-desc">Sold: High→Low</option>
          <option value="daily-desc">Daily Rate: High→Low</option>
          <option value="cover-asc">Cover: Least First</option>
          <option value="name-asc">Name A→Z</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Part Type</th><th>Model</th><th>Brand</th><th>In Stock</th><th>Sold/Mo</th><th>Daily Rate</th><th>Weekly Rate</th><th>Days Cover</th><th>Status</th></tr></thead>
          <tbody id="cat-body"><tr><td colspan="9"><div class="empty"><div class="empty-title">Sync to view</div></div></td></tr></tbody>
        </table>
      </div>
      <div id="cat-count" style="color:var(--text3);font-family:var(--mono);font-size:11px;margin-top:8px;"></div>
    </div>

    <!-- DEAD STOCK -->
    <div class="page" id="page-deadstock">
      <div class="page-title">Inventory Health</div>
      <div class="page-heading">Dead Stock Report</div>
      <div class="page-sub">Zero sales this month AND last month — consider clearing or returning to supplier</div>
      <div id="deadstock-content"><div class="empty"><div class="empty-title">Sync data to view</div></div></div>
    </div>

    <!-- FORECAST -->
    <div class="page" id="page-forecast">
      <div class="page-title">SA Demand Forecast</div>
      <div class="page-heading">Order Recommendations</div>
      <div class="page-sub">Based on your actual sales velocity, 20 repairs/day, 2-3 day SA lead time, 7.5% growth target</div>
      <div id="forecast-sa-alerts" style="margin-bottom:16px;"></div>
      <div id="forecast-content"><div class="empty"><div class="empty-title">Sync data then this auto-generates</div></div></div>
    </div>

  </main>
</div>

<script>
// ═══════════════════════════════════
// CONFIG
// ═══════════════════════════════════
const BASE_ID = 'appP1JCcNoTs54a2t';
const SUMMARY_TABLE = 'Parts Inventory Summary';
const LINE_ITEMS_TABLE = 'Line items';
const REPAIRS_PER_DAY = 20;
const LEAD_TIME_DAYS = 3;
const GROWTH_RATE = 1.075;

// ═══════════════════════════════════
// STATE
// ═══════════════════════════════════
let allParts = [];       // from Parts Inventory Summary
let salesData = {};      // { "partType|||model": { thisMonth, lastMonth, daily, weekly } }
let dataLoaded = false;

// ═══════════════════════════════════
// DATE HELPERS
// ═══════════════════════════════════
const now = new Date();
const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

// ═══════════════════════════════════
// NAV
// ═══════════════════════════════════
function nav(el) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('page-' + el.dataset.page).classList.add('active');
}

function switchTab(el, tabId) {
  el.closest('.page').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.closest('.page').querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

// ═══════════════════════════════════
// FETCH
// ═══════════════════════════════════
async function fetchAllPages(table, extraParams = '') {
  let records = [], offset = null;
  do {
    let url = `/api/airtable?base=${BASE_ID}&table=${encodeURIComponent(table)}${extraParams}`;
    if (offset) url += `&offset=${encodeURIComponent(offset)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) throw new Error(JSON.stringify(data.error));
    records = records.concat(data.records || []);
    offset = data.offset;
  } while (offset);
  return records;
}

// ═══════════════════════════════════
// LOAD ALL DATA
// ═══════════════════════════════════
async function loadAll() {
  const btn = document.getElementById('load-btn');
  btn.disabled = true; btn.textContent = 'SYNCING...';
  setSyncStatus('syncing', 'Loading summary...');

  try {
    // 1. Load Parts Inventory Summary
    const summaryRecords = await fetchAllPages(SUMMARY_TABLE);
    allParts = summaryRecords.map(r => {
      const f = r.fields;
      return {
        id: r.id,
        sku: f['SKU'] || '',
        partType: f['Part Type'] || '',
        model: f['Device Model'] || '',
        brand: f['Brand'] || '',
        inStock: Number(f['Total In Stock']) || 0,
        usedMonth: Number(f['Total Used This Month']) || 0,
        totalCount: Number(f['Total Count']) || 0,
      };
    });

    setSyncStatus('syncing', `Loaded ${allParts.length} SKUs. Loading sales data...`);

    // 2. Load Line Items for sales analysis
    // Filter: Last desig of device = SOLD, and Allocation Timestamp in last 60 days
    const sixtyDaysAgo = new Date(now - 60 * 24 * 60 * 60 * 1000).toISOString();
    const filterFormula = `AND({Last desig of device}="SOLD",IS_AFTER({Allocation Timestamp},"${sixtyDaysAgo}"))`;
    const fieldsParam = `fields[]=Part Type&fields[]=Models Strict (2)&fields[]=Brand 2&fields[]=Allocation Timestamp&fields[]=Last desig of device`;

    const lineRecords = await fetchAllPages(LINE_ITEMS_TABLE, `&${fieldsParam}&filterByFormula=${encodeURIComponent(filterFormula)}`);

    setSyncStatus('syncing', `Processing ${lineRecords.length} sales records...`);

    // 3. Build sales data
    salesData = {};
    for (const r of lineRecords) {
      const f = r.fields;
      const partType = (f['Part Type'] || 'Unknown').trim();
      const model = (f['Models Strict (2)'] || 'Unknown').trim();
      const brand = (f['Brand 2'] || '').trim();
      const ts = f['Allocation Timestamp'];
      if (!ts) continue;
      const date = new Date(ts);
      const key = `${partType}|||${model}`;

      if (!salesData[key]) salesData[key] = { partType, model, brand, thisMonth: 0, lastMonth: 0, last30: 0, allTime: 0 };
      salesData[key].allTime++;
      if (date >= thisMonthStart) salesData[key].thisMonth++;
      if (date >= lastMonthStart && date <= lastMonthEnd) salesData[key].lastMonth++;
      if (date >= thirtyDaysAgo) salesData[key].last30++;
    }

    // Compute daily/weekly rates from 30-day rolling
    for (const key of Object.keys(salesData)) {
      const d = salesData[key];
      d.daily = d.last30 / 30;
      d.weekly = d.last30 / 4.3;
    }

    // Merge sales data into allParts
    allParts = allParts.map(p => {
      const key = `${p.partType}|||${p.model}`;
      const s = salesData[key] || { thisMonth: 0, lastMonth: 0, last30: 0, daily: 0, weekly: 0 };
      const daysRemaining = s.daily > 0 ? Math.floor(p.inStock / s.daily) : 999;
      return { ...p, ...s, daysRemaining };
    });

    setSyncStatus('live', `Synced ${allParts.length} SKUs · ${lineRecords.length} sales`);
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString('en-ZA');
    dataLoaded = true;
    populateFilters();
    renderAll();

  } catch(e) {
    setSyncStatus('error', 'Error: ' + e.message);
    alert('Sync failed: ' + e.message);
  }

  btn.disabled = false; btn.textContent = '⟳ SYNC DATA';
}

function setSyncStatus(state, msg) {
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-label');
  const status = document.getElementById('sync-status');
  if (state === 'live') { dot.className = 'dot'; label.textContent = 'LIVE'; }
  else if (state === 'syncing') { dot.className = 'dot yellow'; label.textContent = 'SYNCING'; }
  else { dot.className = 'dot red'; label.textContent = 'ERROR'; }
  if (status && msg) status.textContent = msg;
}

// ═══════════════════════════════════
// RENDER ALL
// ═══════════════════════════════════
function renderAll() {
  renderDashboard();
  renderReorder();
  renderRunout();
  renderTopMovers();
  renderCatalogue();
  renderDeadStock();
  renderForecast();
  updateBadges();
}

function populateFilters() {
  const brands = [...new Set(allParts.map(p => p.brand).filter(Boolean))].sort();
  const types = [...new Set(allParts.map(p => p.partType).filter(Boolean))].sort();

  ['reorder-brand', 'cat-brand'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    el.innerHTML = '<option value="">All Brands</option>' + brands.map(b => `<option>${b}</option>`).join('');
  });
  ['reorder-type', 'cat-type'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    el.innerHTML = '<option value="">All Types</option>' + types.map(t => `<option>${t}</option>`).join('');
  });
}

function updateBadges() {
  const safeStock = p => Math.ceil((p.daily * (LEAD_TIME_DAYS + 7)));
  const reorderCount = allParts.filter(p => p.daily > 0 && p.inStock < safeStock(p)).length;
  const runoutCount = allParts.filter(p => p.daysRemaining <= 7 && p.daily > 0).length;

  const rb = document.getElementById('reorder-badge');
  rb.textContent = reorderCount; rb.style.display = reorderCount > 0 ? 'inline-block' : 'none';
  const rnb = document.getElementById('runout-badge');
  rnb.textContent = runoutCount; rnb.style.display = runoutCount > 0 ? 'inline-block' : 'none';
  document.getElementById('s-reorder').textContent = reorderCount;
}

// ═══════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════
function renderDashboard() {
  const activeSKUs = allParts.filter(p => p.thisMonth > 0 || p.inStock > 0).length;
  const totalStock = allParts.reduce((a, p) => a + p.inStock, 0);
  const totalSoldMonth = allParts.reduce((a, p) => a + p.thisMonth, 0);
  const totalDaily = allParts.reduce((a, p) => a + p.daily, 0);
  const avgCover = totalDaily > 0 ? Math.floor(totalStock / totalDaily) : 0;

  document.getElementById('s-skus').textContent = activeSKUs.toLocaleString();
  document.getElementById('s-stock').textContent = totalStock.toLocaleString();
  document.getElementById('s-sold').textContent = totalSoldMonth.toLocaleString();
  document.getElementById('d-daily').textContent = totalDaily.toFixed(1);
  document.getElementById('d-weekly').textContent = (totalDaily * 7).toFixed(0);
  document.getElementById('d-cover').textContent = avgCover + 'd';
  document.getElementById('dashboard-sub').textContent =
    `${activeSKUs} active SKUs · ${totalStock} units in stock · ${totalSoldMonth} sold this month · ${totalDaily.toFixed(1)} parts/day avg`;

  // Top 8 by stock
  const topStock = [...allParts].sort((a, b) => b.inStock - a.inStock).slice(0, 8);
  const maxStock = topStock[0]?.inStock || 1;
  document.getElementById('top-stock-list').innerHTML = topStock.map(p => `
    <div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px">
        <span style="font-size:13px">${p.partType} <span style="color:var(--text3);font-size:11px">${p.model}</span></span>
        <span class="num" style="color:var(--accent3)">${p.inStock}</span>
      </div>
      <div class="progress"><div class="progress-fill" style="width:${(p.inStock/maxStock*100).toFixed(0)}%;background:var(--accent3)"></div></div>
    </div>`).join('');

  // Top 8 sold this month
  const topSold = [...allParts].filter(p => p.thisMonth > 0).sort((a, b) => b.thisMonth - a.thisMonth).slice(0, 8);
  const maxSold = topSold[0]?.thisMonth || 1;
  document.getElementById('top-sold-list').innerHTML = topSold.length ? topSold.map(p => `
    <div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px">
        <span style="font-size:13px">${p.partType} <span style="color:var(--text3);font-size:11px">${p.model}</span></span>
        <span class="num" style="color:var(--accent4)">${p.thisMonth}</span>
      </div>
      <div class="progress"><div class="progress-fill" style="width:${(p.thisMonth/maxSold*100).toFixed(0)}%;background:var(--accent4)"></div></div>
    </div>`).join('') : '<div style="color:var(--text3);font-size:12px">No sales data this month</div>';

  // Brand breakdown by sales
  const brands = {}, types = {};
  allParts.forEach(p => {
    const b = p.brand || 'Unknown'; brands[b] = (brands[b] || 0) + p.thisMonth;
    const t = p.partType || 'Unknown'; types[t] = (types[t] || 0) + p.thisMonth;
  });
  const brandE = Object.entries(brands).sort((a, b) => b[1] - a[1]).slice(0, 8);
  const maxB = brandE[0]?.[1] || 1;
  document.getElementById('brand-breakdown').innerHTML = brandE.map(([b, c]) => `
    <div style="margin-bottom:9px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>${b}</span><span class="num" style="font-size:11px;color:var(--text3)">${c} sold</span></div>
      <div class="progress"><div class="progress-fill" style="width:${(c/maxB*100).toFixed(0)}%;background:var(--accent)"></div></div>
    </div>`).join('');

  const typeE = Object.entries(types).sort((a, b) => b[1] - a[1]).slice(0, 8);
  const maxT = typeE[0]?.[1] || 1;
  document.getElementById('type-breakdown').innerHTML = typeE.map(([t, c]) => `
    <div style="margin-bottom:9px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>${t}</span><span class="num" style="font-size:11px;color:var(--text3)">${c} sold</span></div>
      <div class="progress"><div class="progress-fill" style="width:${(c/maxT*100).toFixed(0)}%;background:var(--accent4)"></div></div>
    </div>`).join('');
}

// ═══════════════════════════════════
// REORDER
// ═══════════════════════════════════
function renderReorder() {
  const brand = document.getElementById('reorder-brand')?.value || '';
  const type = document.getElementById('reorder-type')?.value || '';

  // Safe stock = enough to cover lead time + 1 week buffer
  const safeStock = p => Math.ceil(p.daily * (LEAD_TIME_DAYS + 7));
  const orderQty = p => Math.ceil(p.daily * 30 * GROWTH_RATE) - p.inStock;

  let parts = allParts.filter(p => {
    const needsReorder = p.daily > 0 && p.inStock < safeStock(p);
    return needsReorder && (!brand || p.brand === brand) && (!type || p.partType === type);
  }).sort((a, b) => a.daysRemaining - b.daysRemaining);

  if (!parts.length) {
    document.getElementById('reorder-content').innerHTML = `<div class="alert alert-green">All parts above safe stock levels. No reorders needed this week.</div>`;
    return;
  }

  const critical = parts.filter(p => p.daysRemaining <= 3);
  const urgent = parts.filter(p => p.daysRemaining > 3 && p.daysRemaining <= 7);
  const normal = parts.filter(p => p.daysRemaining > 7);

  document.getElementById('reorder-content').innerHTML = `
    ${critical.length ? `<div class="alert alert-red"><strong>${critical.length} CRITICAL</strong> — Stock out within 3 days. Order immediately.</div>` : ''}
    ${urgent.length ? `<div class="alert alert-yellow"><strong>${urgent.length} URGENT</strong> — Stock out within 7 days.</div>` : ''}
    <div class="table-wrap"><table>
      <thead><tr><th>Part Type</th><th>Model</th><th>Brand</th><th>In Stock</th><th>Daily Rate</th><th>Days Left</th><th>Order Qty</th><th>Priority</th></tr></thead>
      <tbody>${parts.map(p => {
        const days = p.daysRemaining;
        const priority = days <= 3 ? ['CRITICAL','badge-red'] : days <= 7 ? ['URGENT','badge-red'] : ['REORDER','badge-yellow'];
        const qty = Math.max(1, orderQty(p));
        return `<tr>
          <td><strong>${p.partType}</strong></td>
          <td style="color:var(--text2)">${p.model}</td>
          <td>${p.brand ? `<span class="badge badge-blue">${p.brand}</span>` : '—'}</td>
          <td><span class="num" style="color:${days<=3?'var(--accent2)':days<=7?'var(--accent4)':'var(--text)'}">${p.inStock}</span></td>
          <td><span class="num" style="color:var(--text2)">${p.daily.toFixed(2)}/day</span></td>
          <td><span class="num" style="color:${days<=3?'var(--accent2)':days<=7?'var(--accent4)':'var(--accent3)'}">${days === 999 ? '∞' : days + 'd'}</span></td>
          <td><span class="num" style="font-size:18px;color:var(--accent)">${qty}</span></td>
          <td><span class="badge ${priority[1]}">${priority[0]}</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>
    <div style="color:var(--text3);font-family:var(--mono);font-size:11px;margin-top:8px;">${parts.length} parts need reordering · Order quantities based on 30-day supply + ${GROWTH_RATE*100-100}% growth</div>`;
}

// ═══════════════════════════════════
// 7-DAY RUNOUT
// ═══════════════════════════════════
function renderRunout() {
  const parts = allParts.filter(p => p.daily > 0 && p.daysRemaining <= 7)
    .sort((a, b) => a.daysRemaining - b.daysRemaining);

  if (!parts.length) {
    document.getElementById('runout-content').innerHTML = `<div class="alert alert-green">No parts running out in the next 7 days.</div>`;
    return;
  }

  document.getElementById('runout-content').innerHTML = `
    <div class="alert alert-red" style="margin-bottom:16px"><strong>${parts.length} parts</strong> will run out within 7 days at current usage rate</div>
    <div class="table-wrap"><table>
      <thead><tr><th>Part Type</th><th>Model</th><th>Brand</th><th>In Stock</th><th>Daily Rate</th><th>Runs Out</th><th>Action</th></tr></thead>
      <tbody>${parts.map(p => {
        const runoutDate = new Date(now.getTime() + p.daysRemaining * 24 * 60 * 60 * 1000);
        const dateStr = runoutDate.toLocaleDateString('en-ZA', { weekday: 'short', month: 'short', day: 'numeric' });
        return `<tr>
          <td><strong>${p.partType}</strong></td>
          <td style="color:var(--text2)">${p.model}</td>
          <td>${p.brand ? `<span class="badge badge-blue">${p.brand}</span>` : '—'}</td>
          <td><span class="num" style="color:var(--accent2)">${p.inStock}</span></td>
          <td class="num">${p.daily.toFixed(2)}/day</td>
          <td><span class="num" style="color:var(--accent2)">${p.daysRemaining === 0 ? 'TODAY' : dateStr}</span></td>
          <td><span class="badge ${p.daysRemaining <= 2 ? 'badge-red' : 'badge-yellow'}">${p.daysRemaining <= 2 ? 'ORDER NOW' : 'ORDER SOON'}</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`;
}

// ═══════════════════════════════════
// TOP MOVERS
// ═══════════════════════════════════
function renderTopMovers() {
  const moversTable = (parts, sortKey) => {
    if (!parts.length) return '<div class="empty"><div class="empty-title">No data</div></div>';
    return `<div class="table-wrap"><table>
      <thead><tr><th>#</th><th>Part Type</th><th>Model</th><th>Brand</th><th>Sold/Month</th><th>Daily Rate</th><th>Weekly Rate</th><th>In Stock</th><th>Days Cover</th></tr></thead>
      <tbody>${parts.map((p, i) => `<tr>
        <td class="sku">${i+1}</td>
        <td><strong>${p.partType}</strong></td>
        <td style="color:var(--text2)">${p.model}</td>
        <td>${p.brand ? `<span class="badge badge-blue">${p.brand}</span>` : '—'}</td>
        <td><span class="num" style="color:var(--accent4)">${p.thisMonth}</span></td>
        <td><span class="num" style="color:var(--accent)">${p.daily.toFixed(2)}</span></td>
        <td><span class="num" style="color:var(--accent)">${p.weekly.toFixed(1)}</span></td>
        <td><span class="num" style="color:var(--accent3)">${p.inStock}</span></td>
        <td><span class="num" style="color:${p.daysRemaining<=7?'var(--accent2)':p.daysRemaining<=14?'var(--accent4)':'var(--accent3)'}">${p.daysRemaining===999?'∞':p.daysRemaining+'d'}</span></td>
      </tr>`).join('')}</tbody>
    </table></div>`;
  };

  const bySold = [...allParts].filter(p => p.thisMonth > 0).sort((a, b) => b.thisMonth - a.thisMonth).slice(0, 20);
  const byDaily = [...allParts].filter(p => p.daily > 0).sort((a, b) => b.daily - a.daily).slice(0, 20);
  const byCover = [...allParts].filter(p => p.daily > 0).sort((a, b) => a.daysRemaining - b.daysRemaining).slice(0, 20);

  document.getElementById('top-sold-table').innerHTML = moversTable(bySold);
  document.getElementById('top-daily-table').innerHTML = moversTable(byDaily);
  document.getElementById('top-cover-table').innerHTML = moversTable(byCover);
}

// ═══════════════════════════════════
// CATALOGUE
// ═══════════════════════════════════
function renderCatalogue() {
  const search = (document.getElementById('cat-search')?.value || '').toLowerCase();
  const brand = document.getElementById('cat-brand')?.value || '';
  const type = document.getElementById('cat-type')?.value || '';
  const sort = document.getElementById('cat-sort')?.value || 'sold-desc';

  let parts = allParts.filter(p => {
    const ms = !search || (p.partType||'').toLowerCase().includes(search) || (p.model||'').toLowerCase().includes(search) || (p.brand||'').toLowerCase().includes(search) || (p.sku||'').toLowerCase().includes(search);
    return ms && (!brand || p.brand === brand) && (!type || p.partType === type);
  });

  if (sort === 'stock-desc') parts.sort((a, b) => b.inStock - a.inStock);
  else if (sort === 'stock-asc') parts.sort((a, b) => a.inStock - b.inStock);
  else if (sort === 'sold-desc') parts.sort((a, b) => b.thisMonth - a.thisMonth);
  else if (sort === 'daily-desc') parts.sort((a, b) => b.daily - a.daily);
  else if (sort === 'cover-asc') parts.sort((a, b) => a.daysRemaining - b.daysRemaining);
  else parts.sort((a, b) => (a.partType||'').localeCompare(b.partType||''));

  const tbody = document.getElementById('cat-body');
  if (!parts.length) { tbody.innerHTML = '<tr><td colspan="9"><div class="empty"><div class="empty-title">No parts match</div></div></td></tr>'; return; }

  tbody.innerHTML = parts.map(p => {
    const cover = p.daysRemaining === 999 ? '∞' : p.daysRemaining + 'd';
    const coverColor = p.daysRemaining <= 7 ? 'var(--accent2)' : p.daysRemaining <= 14 ? 'var(--accent4)' : 'var(--accent3)';
    const status = p.inStock === 0 ? ['OUT', 'badge-red'] : p.daysRemaining <= 7 ? ['LOW', 'badge-yellow'] : ['OK', 'badge-green'];
    return `<tr>
      <td><strong>${p.partType||'—'}</strong></td>
      <td style="color:var(--text2)">${p.model||'—'}</td>
      <td>${p.brand ? `<span class="badge badge-blue">${p.brand}</span>` : '—'}</td>
      <td><span class="num" style="color:var(--accent3)">${p.inStock}</span></td>
      <td><span class="num" style="color:var(--accent4)">${p.thisMonth}</span></td>
      <td class="num">${p.daily.toFixed(2)}/d</td>
      <td class="num">${p.weekly.toFixed(1)}/wk</td>
      <td><span class="num" style="color:${coverColor}">${cover}</span></td>
      <td><span class="badge ${status[1]}">${status[0]}</span></td>
    </tr>`;
  }).join('');
  document.getElementById('cat-count').textContent = `Showing ${parts.length} of ${allParts.length} SKUs`;
}

// ═══════════════════════════════════
// DEAD STOCK
// ═══════════════════════════════════
function renderDeadStock() {
  const dead = allParts.filter(p => p.thisMonth === 0 && p.lastMonth === 0 && p.inStock > 0)
    .sort((a, b) => b.inStock - a.inStock);

  if (!dead.length) {
    document.getElementById('deadstock-content').innerHTML = `<div class="alert alert-green">No dead stock detected. All parts with stock have had recent sales.</div>`;
    return;
  }

  const totalDeadUnits = dead.reduce((a, p) => a + p.inStock, 0);

  document.getElementById('deadstock-content').innerHTML = `
    <div class="alert alert-yellow" style="margin-bottom:16px"><strong>${dead.length} SKUs</strong> with ${totalDeadUnits} total units — zero sales this month and last month</div>
    <div class="table-wrap"><table>
      <thead><tr><th>Part Type</th><th>Model</th><th>Brand</th><th>In Stock</th><th>Total Count</th><th>Last Month Sales</th><th>Recommendation</th></tr></thead>
      <tbody>${dead.map(p => `<tr>
        <td><strong>${p.partType||'—'}</strong></td>
        <td style="color:var(--text2)">${p.model||'—'}</td>
        <td>${p.brand ? `<span class="badge badge-blue">${p.brand}</span>` : '—'}</td>
        <td><span class="num" style="color:var(--accent4)">${p.inStock}</span></td>
        <td class="sku">${p.totalCount.toLocaleString()}</td>
        <td><span class="num" style="color:var(--text3)">0</span></td>
        <td><span class="badge badge-yellow">REVIEW</span></td>
      </tr>`).join('')}</tbody>
    </table></div>
    <div style="color:var(--text3);font-family:var(--mono);font-size:11px;margin-top:8px;">Consider returning to supplier, discounting, or bundling with active repairs</div>`;
}

// ═══════════════════════════════════
// FORECAST
// ═══════════════════════════════════
function renderForecast() {
  const MIN_SALES = 5;
  const ORDER_DAYS = 7;
  const month = now.getMonth();
  const seasonMult = month === 11 ? 1.4 : month === 0 ? 0.75 : (month === 5 || month === 6) ? 1.2 : 1.0;
  const catW = { 'battery':1.6,'lcd':1.5,'screen':1.5,'oled':1.5,'soft oled':1.5,'charging dock':1.4,'charging port':1.4,'flex':1.2,'camera':1.1 };

  const eligible = allParts.filter(p => p.last30 >= MIN_SALES);
  if (!eligible.length) {
    document.getElementById('forecast-content').innerHTML = '<div class="empty"><div class="empty-title">No parts with 5+ sales in last 30 days</div></div>';
    return;
  }

  const orderList = eligible.map(p => {
    const pl = (p.partType||'').toLowerCase();
    let cw = 1.0;
    for (const [k, w] of Object.entries(catW)) { if (pl.includes(k)) { cw = w; break; } }
    const dailyRate = p.last30 / 30;
    const weeklyNeed = dailyRate * ORDER_DAYS * GROWTH_RATE * seasonMult * cw;
    const safeBuffer = dailyRate * LEAD_TIME_DAYS;
    const totalNeed = Math.ceil(weeklyNeed + safeBuffer);
    const toOrder = Math.max(0, totalNeed - p.inStock);
    const daysAfterOrder = dailyRate > 0 ? Math.floor((p.inStock + toOrder) / dailyRate) : 999;
    return { ...p, dailyRate, toOrder, daysAfterOrder };
  }).filter(p => p.toOrder > 0).sort((a, b) => b.last30 - a.last30);

  if (!orderList.length) {
    document.getElementById('forecast-content').innerHTML = '<div class="alert alert-green">All fast-moving parts are well stocked for the week ahead. No orders needed.</div>';
    return;
  }

  // Group by Brand
  const byBrand = {};
  for (const p of orderList) {
    const brand = p.brand || 'Unknown';
    if (!byBrand[brand]) byBrand[brand] = [];
    byBrand[brand].push(p);
  }
  const brandsSorted = Object.entries(byBrand).sort((a, b) =>
    b[1].reduce((s,p)=>s+p.toOrder,0) - a[1].reduce((s,p)=>s+p.toOrder,0)
  );

  const totalUnits = orderList.reduce((a, p) => a + p.toOrder, 0);
  const weekOf = now.toLocaleDateString('en-ZA', { day:'numeric', month:'long', year:'numeric' });

  let html = `
    <div style="background:var(--bg3);border:1px solid var(--border);border-left:3px solid var(--accent);padding:18px;border-radius:2px;margin-bottom:24px">
      <div style="font-family:var(--mono);font-size:10px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:6px">Weekly Order Recommendation</div>
      <div style="font-size:16px;font-weight:600;margin-bottom:6px">Week of ${weekOf}</div>
      <div style="color:var(--text2);font-size:13px;line-height:1.6">
        Based on your last 30 days of sales, you need to order <strong style="color:var(--text)">${totalUnits} units</strong> across <strong style="color:var(--text)">${orderList.length} parts</strong> to cover the next 7 days.
        Only parts sold 5 or more times in the last 30 days are included. Each quantity includes a ${LEAD_TIME_DAYS}-day supplier lead time buffer.
      </div>
    </div>`;

  for (const [brand, parts] of brandsSorted) {
    const brandTotal = parts.reduce((s, p) => s + p.toOrder, 0);
    const brandSold = parts.reduce((s, p) => s + p.last30, 0);
    const fastestMover = [...parts].sort((a,b) => b.last30 - a.last30)[0];

    html += `
      <div class="card section-gap">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
          <div>
            <span class="badge badge-blue" style="font-size:12px;padding:4px 14px;margin-bottom:8px;display:inline-block">${brand}</span>
            <div style="color:var(--text2);font-size:13px">${brand} is one of your active brands — <strong style="color:var(--text)">${parts.length} part${parts.length>1?'s':''}</strong> need restocking, totalling <strong style="color:var(--accent)">${brandTotal} units</strong>. Your fastest ${brand} mover is the <strong style="color:var(--text)">${fastestMover.model} ${fastestMover.partType}</strong> with ${fastestMover.last30} sales in the last 30 days.</div>
          </div>
          <div style="text-align:right;min-width:80px;margin-left:16px">
            <div style="font-family:var(--mono);font-size:26px;color:var(--accent);line-height:1">${brandTotal}</div>
            <div style="font-family:var(--mono);font-size:10px;color:var(--text3)">units</div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);margin:14px 0"></div>
        <div style="display:flex;flex-direction:column;gap:10px">
          ${parts.map(p => {
            const urgency = p.daysRemaining <= 3 ? 'var(--accent2)' : p.daysRemaining <= 7 ? 'var(--accent4)' : 'var(--accent3)';
            const urgencyText = p.daysRemaining === 0 ? 'OUT OF STOCK' : p.daysRemaining <= 3 ? `Runs out in ${p.daysRemaining}d — urgent` : p.daysRemaining <= 7 ? `Runs out in ${p.daysRemaining}d` : `${p.inStock} left in stock`;
            const coverText = p.daysAfterOrder >= 999 ? 'covers indefinitely' : `should last ${p.daysAfterOrder} days after ordering`;
            return `<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--bg3);border-radius:2px;border:1px solid var(--border)">
              <div style="flex:1">
                <div style="font-size:14px;font-weight:600;margin-bottom:3px">${p.model} — ${p.partType}</div>
                <div style="font-size:12px;color:var(--text2)">Order <strong style="color:var(--accent);font-family:var(--mono);font-size:15px">${p.toOrder}</strong> units · ${coverText} · <span style="color:${urgency}">${urgencyText}</span></div>
              </div>
              <div style="text-align:right;min-width:60px;margin-left:12px">
                <div style="font-family:var(--mono);font-size:28px;font-weight:500;color:var(--accent);line-height:1">${p.toOrder}</div>
                <div style="font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:1px">QTY</div>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
  }

  html += `<div style="color:var(--text3);font-family:var(--mono);font-size:11px;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:2px;line-height:1.8">
    ORDER NOTES · Quantities cover 7 days + ${LEAD_TIME_DAYS}-day lead buffer · ${(GROWTH_RATE-1)*100}% growth factor applied · Parts below 5 sales/30d excluded · Parts with sufficient stock excluded automatically
  </div>`;

  document.getElementById('forecast-content').innerHTML = html;
  document.getElementById('forecast-sa-alerts').innerHTML = '';
}
</script>
</body>
</html>
